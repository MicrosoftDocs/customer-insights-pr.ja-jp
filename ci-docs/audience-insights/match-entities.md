---
title: データ統合のためにエンティティを照合する
description: データを照合して、統合顧客プロファイルを作成します。
ms.date: 01/28/2022
ms.service: customer-insights
ms.subservice: audience-insights
ms.topic: tutorial
author: adkuppa
ms.author: adkuppa
ms.reviewer: mhart
manager: shellyha
searchScope:
  - ci-match
---

# <a name="match-entities"></a>エンティティを一致させる

一致フェーズでは、データセットを統合して顧客プロファイルデータセットを統合する方法を指定します。 データ統合プロセスの [マップ ステップ](map-entities.md) を完了後、エンティティを照合する準備ができました。 一致フェーズには少なくとも 2 つのマッピングされたエンティティ が必要です。

照合ページは、次の 3 つのセクションで構成されます: 
- 一致するレコードの数を要約する重要な指標
- エンティティ間照合の照合順序とルール
- 照合エンティティの重複排除ルール

## <a name="specify-the-match-order"></a>一致順を指定します。

**データ** > **統一する** > **一致** に移動してから、**順序の設定** を設定して照合フェーズを開始します。

各照合では、2 つ以上のエンティティを単一の連結エンティティに統合します。 同時に、一意の顧客レコードを保持します。 たとえば、次の 2 つのエンティティを選択しました: 主エンティティとして **eCommerce:eCommerceContacts** と 2番目のエンティティとして **LoyaltyScheme:loyCustomers**。 エンティティの順序は、システムがレコードの照合を試みる順序を指定します。

:::image type="content" source="media/match-page.png" alt-text="データ統合プロセスの統合領域にある照合ページのスクリーンショット。":::
  
主エンティティ *eCommerce:eCommerceContacts* は、次のエンティティ *LoyaltyScheme:loyCustomers* と一致します。 3 つ以上のエンティティがある場合、最初の照合ステップの結果であるデータセットは、次のエンティティと一致します。

> [!IMPORTANT]
> 主エンティティとして選択したエンティティは、統合プロファイル データセットの基盤として機能します。 一致フェーズで選択された追加のエンティティは、このエンティティに追加されます。 これは、統合されたエンティティに、このエンティティに含まれる *すべて* のデータが、含まれるという意味ではありません。
>
> エンティティの階層を選択する際に役立つ 2 つの考慮事項があります。
>
> - 主エンティティとして、顧客に関する最も完全で信頼性の高いプロファイル データを持つエンティティを選択します。
> - 他のエンティティと共通のいくつかの属性 (例えば、名前、電話番号、電子メール アドレス) を持つエンティティを主エンティティとして選択します。

照合順序を指定すると、定義された照合ペアが **データ** > **統合** > **照合** の **一致したレコードの詳細** セクションに表示されます。 照合プロセスが完了するまで、重要な指標は空になります。

## <a name="define-rules-for-match-pairs"></a>照合ペアのルールを定義する

一致ルールは、エンティティの特定のペアが一致するロジックを指定します。

エンティティ名の横にある **ルールが必要です** 警告は、照合ペアに照合ルールが定義されていないことを示します。 

:::image type="content" source="media/match-rule-add.png" alt-text="ルールを追加するコントロールが強調表示された一致したレコードの詳細セクションのスクリーンショット。":::

1. **一致したレコードの詳細** セクションのエンティティの下にある **ルールの追加** を選択して、照合ルールを定義します。

1. **ルールの作成** ペインで、ルールの条件を構成します。

   :::image type="content" source="media/match-rule-conditions.png" alt-text="開かれた条件付き照合ルールのスクリーンショット。":::

   - **エンティティ/フィールド (最初の行)**: 関連エンティティと属性を選択して、顧客に固有である可能性が高いレコード プロパティを指定します。 たとえば、電話番号や電子メール アドレスなどです。 アクティビティ タイプの属性による照合は避けてください。 たとえば、購入 ID は、他のレコードの種類では一致しない可能性があります。

   - **エンティティ/フィールド (2行目)**: 最初の行で指定されたエンティティの属性に関連する属性を選択します。

   - **正規化**: 選択された属性について、次の正規化オプションから選択します。 
     - 空白: すべてのスペースを削除します。 *Hello   World* は、*HelloWorld* になります。
     - 記号: すべての記号と特殊文字を削除します。 *Head&Shoulder* は *HeadShoulder* になります。
     - テキストを小文字に: すべての文字を小文字に変換します。 *ALL CAPS and Title Case* は *all caps and title case* になります。
     - Unicode から ASCII へ: Unicode 表記を ASCII 文字に変換します。 */u00B2* は *2* になります。
     - 数字: ローマ数字などの他の数字システムをアラビア数字に変換します。 *VIII* は *8* になります。
     - セマンティックの種類: 名前、役職、電話番号、住所などを標準化します。 

   - **精度**: この条件に適用する精度のレベルを設定します。 
     - **基本**: *低*、*中*、*高*、*完全一致* から選択します。 **完全** を選択して、100％ に一致するレコードのみを一致させます。 その他のレベルの 1 つを選択して、100％ 同一ではないレコードに一致させます。
     - **カスタム**: レコードが一致する必要がある割合を設定します。 システムは、このしきい値を超えるレコードのみを照合します。

1. **名前** にルールの名前を入力します。

1. [さらに条件を追加](#add-conditions-to-a-rule) するか、 **完了** を選択して、ルールの作成を完了します。

1. オプションで、[ルールをさらに追加](#add-rules-to-a-match-pair) します。

1. **保存** を選択して変更を適用します。

### <a name="add-conditions-to-a-rule"></a>ルールに条件を追加する

属性が複数の条件を満たす場合にのみエンティティを照合するには、照合ルールにさらに条件を追加します。 条件は論理 AND 演算子で接続されるため、すべての条件が満たされた場合にのみ実行されます。

1. **データ** > **統合** > **照合** に移動し、条件を追加するルールで **編集** を選択します。

1. **ルールを編集** ウィンドウで、**条件を追加** を選択します。

1. **完了** を選択して、ルールを保存します。

### <a name="add-rules-to-a-match-pair"></a>照合ペアにルールを追加する

照合ルールは条件セットを表します。 複数の属性に基づく条件によってエンティティを照合するには、ルールをさらに追加します

1.  **データ** > **統合** > **照合** に移動し、ルールを追加するエンティティで **ルールの追加** を選択します。

2. [照合ペアのルールを定義する](#define-rules-for-match-pairs) の手順に従います。

> [!NOTE]
> ルールの順序は重要です。 照合アルゴリズムでは、最初のルールに基づいて照合を試み、最初のルールで一致するものがなかった場合に限り、2 番目のルールに進みます。

### <a name="change-the-entity-order-in-match-rules"></a>照合ルールでエンティティの順序を変更する

照合ルールのエンティティを並べ替えて、処理順序を変更できます。 順序が変更されたため競合しているルールは削除されます。 削除されたルールを更新された構成で再作成する必要があります。

1. **データ** > **統合** > **照合** に移動して、**編集** を選択します。

1. **ルールの編集** ペインで、**上/下へ移動** コントロールを選択するか、エンティティをドラッグ アンド ドロップして、順序を変更します。

   :::image type="content" source="media/reorder-match-rules.png" alt-text="照合フェーズでエンティティが処理される順序を変更するオプション。":::

1. **完了** を選択して、ルールを保存します。

## <a name="define-deduplication-on-a-match-entity"></a>照合エンティティで重複排除を定義する

[エンティティ間の照合ルール](#define-rules-for-match-pairs) に加えて、重複排除ルールを指定することもできます。 *重複排除* は、レコードを照合するときの別のプロセスです。 重複レコードを特定し、1 つのレコードにマージします。 ソース レコードは、代替 IDを使用してマージされたレコードにリンクされます。

重複排除されたレコードは、エンティティ間の照合プロセスで使用されます。 重複排除は個々のエンティティで行われるので、照合ペアで使用される各エンティティを構成できます。

重複排除ルールの指定は必須ではありません。 そのようなルールが構成されていない場合は、システム定義のルールが適用されます。 エンティティ データをエンティティ間照合に渡してパフォーマンスを向上させる前に、すべてのレコードを 1 つのレコードに結合します。

### <a name="add-deduplication-rules"></a>重複排除ルールの追加

1. **データ** > **統合** > **照合** に移動します。

1. **重複排除したレコードの詳細** セクションで、**エンティティの設定** を選択します。 重複排除ルールがすでに作成されている場合は、**編集** を選択します。

1. **基本設定をマージする** ペイン、重複排除を実行するエンティティを選択します。

   1. 重複レコードを結合する方法を指定し、次の 3 つのオプションのいずれかを選択します:
      - **最も多く入力された**: 最も多くの属性フィールドが入力されたレコードを勝者レコードとして識別します。 既定のマージ オプションです。
      - **最も新しい**: 最新性に基づいて勝者レコードを識別します。 最新を定義するには、日付または数値フィールドが必要です。
      - **最も古い**: 最も古いレコードに基づいて勝者レコードを識別します。 最新を定義するには、日付または数値フィールドが必要です。

   1. 必要に応じて、**詳細** を選択し、エンティティの個々の属性に重複排除ルールを定義します。 たとえば、最新のメールと最も完全なアドレスを異なるレコードから保持することを選択できます。 エンティティを展開してすべての属性を表示し、個々の属性に使用するオプションを定義します。 最新性に基づくオプションを選択する場合は、最新性を定義する日付/時刻フィールドも指定する必要があります。 
 
      > [!div class="mx-imgBorder"]
      > ![重複排除ルール ステップ 1。](media/match-selfconflation.png "重複排除ルール ステップ 1")

   1. **完了** を選択して、重複排除のマージの基本設定を適用します。
 
1. エンティティを選択して、マージの基本設定を設定したら、**ルールの追加** を選択して、エンティティ レベルで重複排除ルールを定義します。
   - **フィールドを選択** は、そのエンティティから使用可能なすべてのフィールドを一覧表示します。 重複をチェックするフィールドを選択します。 各顧客に固有である可能性が高いフィールドを選択します。 たとえば、電子メール アドレス、または名前、都市、電話番号の組み合わせです。
   - 正規化と精度の設定を指定します。
   - **条件の追加** を選択して、さらに条件を定義します。
 
   > [!div class="mx-imgBorder"]
   > ![重複排除ルール ステップ 2。](media/match-selfconflation-rules.png "重複排除ルール ステップ 2")

  エンティティに対して複数の重複排除ルールを作成できます。 

1. 照合プロセスを実行すると、重複排除ルールで定義された条件に基づいてレコードがグループ化されます。 レコードをグループ化した後、マージ ポリシーを適用して、勝者レコードを識別します。

1. 次にこの勝者レコードが、非勝者レコード (たとえば、代替 ID) とともに、エンティティ間の照合に渡され、一致の品質が向上します。

1. 定義されたカスタム照合ルールは、重複排除ルールを上書きします。 重複排除ルールが一致するレコードを識別し、カスタム照合ルールがそれらのレコードと照合しないように設定されている場合、これら 2 つのレコードの照合は行われません。

1. [照合プロセスを実行](#run-the-match-process) すると、重複排除の統計が主要指標タイルに表示されます。

### <a name="deduplication-output-as-an-entity"></a>エンティティとしての重複排除出力

重複排除プロセスでは、照合ペアからエンティティごとに新しいエンティティを作成して、重複排除されたレコードを識別します。 これらのエンティティは、**エンティティ** ページの **システム** セクションに **ConflationMatchPairs:CustomerInsights** とともに、**Deduplication_DataSource_Entity** という名前で表示されます。

重複排除出力エンティティには、次の情報が含まれています。
- ID/キー
  - 主キーフィールドとその代替 ID フィールド。 代替 ID フィールドは、レコードに対して識別されたすべての代替 ID で構成されます。
  - Deduplication_GroupId フィールドには、指定された重複排除フィールドに基づいてすべての類似レコードをグループ化するエンティティ内で識別されたグループまたはクラスターが表示されます。 これは、システム処理の目的で使用されます。 手動の重複排除ルールが指定されておらず、システム定義の重複排除ルールが適用されている場合、このフィールドが重複排除出力エンティティに表示されていない可能性があります。
  - Deduplication_WinnerId: このフィールドには、識別されたグループまたはクラスターからの勝者 ID が含まれます。 Deduplication_WinnerId がレコードの主キー値と同じである場合、そのレコードが勝者レコードであることを意味します。
- 重複排除ルールを定義するために使用されるフィールド。
- [ルール] フィールドと [スコア] フィールドは、どの重複排除ルールが適用され、照合アルゴリズムによってスコアが返されことを示します。
   
## <a name="run-the-match-process"></a>照合プロセスを実行する

エンティティ間の照合ルールや重複排除ルールなど、構成された照合ルールを使用して、照合プロセスを実行できます。 

**データ** > **統合** > **照合** に移動し、**実行** を選択して、プロセスを開始します。 照合アルゴリズムは完了するまでに時間がかかり、完了するまで構成を変更することはできません。 変更するには、実行をキャンセルします。 ジョブの状態を選択し、**ジョブの取り消し** を **プロセス詳細** ペインで選択します。

成功した実行結果である、統合した顧客プロファイル エンティティは、**エンティティ** ページで確認できます。 統合された顧客エンティティは、**プロファイル** セクションで **顧客** と呼ばれます。 最初に成功した照合の実行は、統合 *Customer* エンティティを作成します。 後続のすべての照合実行では、そのエンティティが展開されます。

[!INCLUDE [progress-details-include](../includes/progress-details-pane.md)]

## <a name="review-and-validate-your-matches"></a>一致のレビューと検証

**データ** > **統合** > **照合** に移動し、照合ペアの品質を評価し、必要に応じて改善します。

ページ上部のタイルには、一致したレコードと重複レコードの数を集計した重要な指標が表示されます。

:::image type="content" source="media/match-KPIs.png" alt-text="数値と詳細が示された照合ページ上の重要な指標のトリミングされたスクリーンショット。":::

- **一意のソース レコード** は、前回の照合実行で処理された個々のソース レコードの数を示します。
- **一致するレコードと一致しないレコード** は、照合ルールの処理後に残っている一意のレコードの数を強調表示します。
- **一致するレコードのみ** は、すべての照合ペアの一致数を示します。

**一致したレコードの詳細** テーブルで、各照合ペアの結果とそのルールを評価できます。 照合ペアから取得したレコード数と、一致に成功したレコードの割合を比較します。

照合ペアのルールを確認して、ルール レベルで一致に成功したレコードの割合を確認します。 省略記号 (...) を選択してから、**一致プレビュー** を選択し、これらすべてのレコードをルール レベルで表示します。 いくつかのレコードを調べて、それらが正しく一致していることを確認することをお勧めします。

条件でさまざまな精度のしきい値を試して、最適な値を見つけてください。

  1. 試行するルールの省略記号 (...) を選択し、**編集** を選択します。

  2. 修正する条件の精度の値を変更します。

  3. **プレビュー** を選択し、選択した条件に対して一致するレコードと一致しないレコードの数を表示します。

## <a name="manage-match-rules"></a>照合ルールの管理

ほとんどの照合パラメーターを再構成および微調整できます。

:::image type="content" source="media/match-rules-management.png" alt-text="照合ルール オプションを含むドロップダウン メニューのスクリーンショット。":::

- 複数のルールを定義した場合、**ルールの順序を変更** します。 **上に移動** と **下に移動** オプションを選択するか、ドラッグ アンド ドロップで照合ルールを並べ替えることができます。

- **編集** を選択して **ルール条件を変更** し、別のフィールドを選択します。

- **ルールを非アクティブ化する** は、照合ルールを保持しながら、照合プロセスから除外します。

- 照合ルールを定義後、変更を加えて同様のルールを作成する場合は、**ルールを複製** して、**複製** を選択します。

- **ルールを削除** するには、**削除** 記号を選択します。

## <a name="advanced-options"></a>詳細オプション

### <a name="add-exceptions-to-a-rule"></a>ルールに例外を追加する

ほとんどの場合、エンティティの照合により、統合されたデータを持つ一意のユーザー プロファイルが作成されます。 偽陽性や偽陰性のまれなケースに動的に対処するために、照合ルールの例外を定義できます。 例外は、照合ルールの処理後に適用され、例外条件を満たすレコードすべての照合を回避します。

たとえば、照合ルールが姓、都市、および生年月日を組み合わせている場合、システムは、同じプロファイルと同じ町に住んでいる同じ姓を持つ双子を識別します。 結合するエンティティの名が同じでない場合は、プロファイルに一致しない例外を指定できます。

1. **データ** > **統合** > **照合** に移動し、条件を追加するルールで **編集** を選択します。

1. **ルールの編集** ペインで、**例外の追加** を選択します。

1. 例外条件を指定します。 

1. **完了** を選択して、ルールを保存します。

### <a name="specify-custom-match-conditions"></a>カスタム照合条件の指定

既定の照合ロジックをオーバーライドする条件を指定できます。 次の 4 つのオプションを使用できます。 

|回答内容  |Description |例  |
|---------|---------|---------|
|常に照合する     | 常に一致する値を定義します。         |  *Mike* と *MikeR* は常に一致します。       |
|照合しない     | 常に一致しない値を定義します。        | *John* と *Jonathan* は常に一致しません。        |
|カスタムのバイパス     | システムが照合フェーズで常に無視するべき値を定義します。 |  照合中に *11111* と *Unknown* の値を無視します。        |
|エイリアス マッピング    | システムが同じ値と見なすべき値を定義します。         | *Joe* が *Joseph* と等しいと見なします。        |

1. **データ** > **統合** > **照合** に移動し、**カスタム照合** を **一致したレコードの詳細** セクションで選択します。

   :::image type="content" source="media/custom-match-create.png" alt-text="カスタム照合コントロールが強調表示された照合ルール セクションのスクリーンショット。":::

1. **カスタム** ペインで **レコード** タブに移動します。

1. **カスタム タイプ** ドロップダウンからカスタム照合オプションを選択し、**テンプレートのダウンロード** を選択します。 照合オプションごとに個別のテンプレートが必要です。

1. ダウンロードしたテンプレート ファイルを開き、詳細を入力します。 テンプレートには、カスタム照合で使用されるエンティティとエンティティの主キーの値を指定するフィールドが含まれています。 たとえば、*Sales* エンティティの主キー *12345* を *Contact* エンティティの主キー *34567* と常に一致させる場合は、テンプレートに次のように入力します:
    - Entity1: Sales
    - Entity1Key: 12345
    - Entity2: Contact
    - Entity2Key: 34567

   同じテンプレート ファイルで、複数のエンティティからカスタム一致レコードを指定できます。
   
   エンティティの重複排除にカスタム照合を指定する場合は、Entity1 とEntity2 の両方と同じエンティティを指定し、異なる主キー値を設定します。

1. オーバーライドをすべて追加してからテンプレート ファイルを保存します。

1. **データ** > **データ ソース** に移動し、テンプレート ファイルを新しいエンティティとして取り込みます。

1. ファイルをアップロードした後、エンティティが利用可能になったら、**カスタム一致** オプションをもう一度選択します。 含めるエンティティを指定するオプションが表示されます。 ドロップダウン メニューから必要なエンティティを選択し、**完了** を選択します。

   :::image type="content" source="media/custom-match-overrides.png" alt-text="カスタム照合シナリオに対する上書きを選択するダイアログのスクリーンショット。":::

1. 使用する照合オプションにより、カスタム照合の適用が異なります。 

   - **常に一致** または **常に不一致** の場合は次のステップに進みます。
   - **カスタム バイパス** または **エイリアス マッピング** の場合は、既存の照合ルールで **編集** を選択するか、新しいルールを作成します。 正規化ドロップダウンから **カスタム バイパス** または **エイリアス マッピング** オプションを選択してから、**完了** を選択します。

1. **照合** ページで **保存** を選択し、カスタム照合構成を適用します。

1. **照合** ページで **実行** を選択し、照合プロセスを開始します。 他の指定された照合ルールは、カスタム照合構成によって上書きされます。

#### <a name="known-issues"></a>既知の問題

- 自己合成は、重複排除エンティティの正規化したデータを表示しません。 ただし、重複を排除する際は内部的に正規化を適用します。 これはすべての正規化に適用される仕様です。 
- 照合ルールにエイリアス マッピングまたはカスタム バイパスを使用する際に、セマンティック タイプの設定を **マップ** フェーズで削除した場合は、正規化が適用されません。 照合ルールの正規化を構成した後は、セマンティック タイプが不明になるため、セマンティック タイプをクリアした場合にのみ発生します。


## <a name="next-step"></a>次のステップ

少なくとも 1 つの照合ペアで照合プロセスが完了したら、[**マージ**](merge-entities.md) ステップに進みます。


[!INCLUDE[footer-include](../includes/footer-banner.md)]
